<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Adding a dynamic maintenance mode to a Rails app &middot; Mohamad El-Husseini
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <img src="/public/mohamad.jpg">
    <p>Mohamad El-Husseini, sharing his brilliant thoughts.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">Hi, I'm Mohamad</a>
        
      
    
      
    

    <a class="sidebar-nav-item" href="https://twitter.com/@abitdodgy">
      <img src="/public/twitter_logo.png" width="24px" height="24px" style="float: right; margin: 0;">
      @abitdodgy on Twitter
    </a>

    <a class="sidebar-nav-item" href="https://github.com/abitdodgy">
      <img src="/public/github_logo.png" width="20px" height="20px" style="float: right; margin: 0;">
      My GitHub profile
    </a>

    <a class="sidebar-nav-item" href="https://instagram.com/abitdodgy">
      <img src="/public/instagram_logo.png" width="24px" height="24px" style="float: right; margin: 0;">
      I'm on Instagram
    </a>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2015. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Mohamad El-Husseini</a>
            <small>Part-time hero, full-time superstar.</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Adding a dynamic maintenance mode to a Rails app</h1>
  <span class="post-date">30 Aug 2015</span>
  <p>During the past month we’ve been busy introducing new features and making changes to our application, Nimbus Work Spaces. On a few occasions we needed to temporarily disable access to the application while we carried out migrations and tests. The first couple of times we disabled access using a <code>before_action</code> that redirected to a maintenance page unless the current user id was whitelisted. But it became clear that having a proper and scalable maintenance strategy is necessary. We have two requirements:</p>

<ol>
  <li>Allow access to some users while the application is in maintenance mode.</li>
  <li>Serve a custom, internationalized template.</li>
</ol>

<p>There are several ways to implement a maintenance mode, but they typically work by bypassing requests to the application server and serving a static HTML page instead. Heroku has a built-in <a href="https://devcenter.heroku.com/articles/maintenance-mode">maintenance feature</a> that works in a similar way, for example. Unfortunately such solutions aren’t dynamic, and thus fail our requirements.</p>

<p>To meet our requirements requests must hit the application so that it can determine how to handle the request, and what language to serve to the user. We implemented this feature by adding a controller action that rendered the maintenance template. We used Rails’ built in I18n for internationalization. Maintenance mode was then enabled and disabled by setting and unsetting an <code>ENV</code> variable respectively.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">DowntimeController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">skip_before_action</span> <span class="ss">:check_maintenance_mode</span>

  <span class="k">def</span> <span class="nf">show</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>The only code of interest here is the <code>skip_before_action</code> call; it ensures that we don’t check for maintenance mode when we are viewing the maintenance page. This stops the application from going into an infinite loop.</p>

<p>We also added a concern to handle the logic, and mixed it into <code>application_controller.rb</code>.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">MaintenanceMode</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="n">before_action</span> <span class="ss">:check_maintenance_mode</span>
  <span class="k">end</span>

<span class="kp">private</span>

  <span class="k">def</span> <span class="nf">check_maintenance_mode</span>
    <span class="k">if</span> <span class="n">maintenance_mode?</span>
      <span class="n">redirect_to</span> <span class="n">maintenance_path</span> <span class="k">unless</span> <span class="n">permitted_ip?</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">maintenance_mode?</span>
    <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MAINTENANCE_MODE&#39;</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">permitted_ip?</span>
    <span class="n">maintainer_ips</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">maintainer_ips</span>
    <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MAINTAINER_IPS&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="nb">String</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">MaintenanceMode</span>
<span class="k">end</span></code></pre></div>

<p>This module adds a <code>before_action</code> that checks if the application is in maintenance mode, and does any work required.</p>

<p>To enter maintenance mode we set an <code>ENV</code> variable on Heroku.</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">heroku config:set MAINTENANCE_MODE=enabled</code></pre></div>

<p>It doesn’t really matter what the value of <code>MAINTENANCE_MODE</code> is (or its name, for that matter), so <em>enabled</em> serves for clarity. The logic checks for the presence of the variable, not its value.</p>

<p>To allow access to an IP address we set another <code>ENV</code> variable. Its value should be a comma-delimited list of IP addresses that we want to enable access for.</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">heroku config:set MAINTAINER_IPS=1.2.3.4,9.8.7.6</code></pre></div>

<p>And finally, to exit maintenance mode.</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">heroku config:unset MAINTENANCE_MODE</code></pre></div>

<p>Our module is also very easy to test.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;test_helper&#39;</span>

<span class="k">class</span> <span class="nc">MaintenanceModeTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MAINTENANCE_MODE&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;enabled&#39;</span>
    <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MAINTAINER_IPS&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;1.2.3.4&#39;</span>
  <span class="k">end</span>

  <span class="n">teardown</span> <span class="k">do</span>
    <span class="no">ENV</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;MAINTENANCE_MODE&#39;</span><span class="p">)</span>
    <span class="no">ENV</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;MAINTAINER_IPS&#39;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">&quot;doesn&#39;t show maintenance page when mode is disabled&quot;</span> <span class="k">do</span>
    <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MAINTENANCE_MODE&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="n">assert_redirected_to</span> <span class="n">maintenance_path</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">&quot;shows maintenance page when mode is enabled&quot;</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">root_path</span>
    <span class="n">assert_redirected_to</span> <span class="n">maintenance_path</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">&quot;doesn&#39;t show maintenance page when IP is whitelisted&quot;</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">root_path</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span> <span class="s1">&#39;REMOTE_ADDR&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1.2.3.4&#39;</span> <span class="p">}</span>
    <span class="n">assert_equal</span> <span class="n">root_path</span><span class="p">,</span> <span class="n">path</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>And there it is, a flexible and dynamic maintenance mode for your Rails application.</p>


</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
  </ul>
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
